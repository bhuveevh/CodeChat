<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CodeChat - Final Fix</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body style="margin:0; padding:0; overflow:hidden; height:100dvh;">

<div id="codechat-root"></div>

<script>
    const root = document.getElementById('codechat-root');
    const shadow = root.attachShadow({mode: 'open'});

    const style = `
        :host { --m3-surface: #f7f9fc; --m3-primary: #6750a4; --m3-sent: #d1e4ff; --m3-received: #f2e7fe; display: block; width: 100vw; height: 100dvh; font-family: 'Roboto', sans-serif; overflow:hidden; }
        * { box-sizing: border-box; }
        .app-container { width: 100%; height: 100%; background: var(--m3-surface); display: flex; flex-direction: column; overflow: hidden; }
        
        #startup { position: absolute; inset: 0; background: #fff; z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: #fff; padding: 30px; border-radius: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 360px; text-align: center; }
        .my-id { font-size: 36px; font-weight: 500; color: var(--m3-primary); margin: 15px 0; letter-spacing: 2px; }
        .input-m3 { width: 100%; border: 1px solid #79747e; padding: 14px; border-radius: 8px; margin-bottom: 20px; font-size: 16px; outline: none; text-align: center; }
        .btn-m3 { background: var(--m3-primary); color: white; border: none; padding: 12px; border-radius: 100px; width: 100%; cursor: pointer; font-weight: 500; opacity: 0.5; pointer-events: none; }
        .btn-m3.active { opacity: 1; pointer-events: auto; }

        .header { height: 56px; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 16px; justify-content: space-between; background: #fff; flex-shrink: 0; }
        .chat-win { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; background: #faf8ff; }
        
        .msg-box { max-width: 85%; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; } .received { align-self: flex-start; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; line-height: 1.4; }
        .sent .bubble { background: var(--m3-sent); border-bottom-right-radius: 4px; color: #001d35; }
        .received .bubble { background: var(--m3-received); border-bottom-left-radius: 4px; color: #21005d; }

        .file-box { width: 220px; border-radius: 12px; overflow: hidden; position: relative; background: #eee; margin-bottom: 4px; border: 1px solid #ddd; }
        .blur-img { width: 100%; height: 160px; object-fit: cover; filter: blur(20px); display: block; }
        .dl-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(103, 80, 164, 0.6); backdrop-filter: blur(8px); color: white; padding: 10px 24px; border-radius: 20px; text-decoration: none; font-size: 14px; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); }
        .ext-label { position: absolute; bottom: 8px; right: 10px; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        .meta-row { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 2px; }
        .file-title { font-size: 10px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        .tick { font-size: 14px; color: #79747e; font-family: 'Material Icons Round'; }

        .footer { background: #fff; border-top: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; }
        .emoji-bar { display: flex; gap: 10px; padding: 8px 12px; overflow-x: auto; background: #f8f8f8; scrollbar-width: none; }
        .emoji { cursor: pointer; font-size: 20px; }
        
        .input-row { padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
        .field-box { flex: 1; background: #f0f0f0; border-radius: 24px; display: flex; align-items: center; padding: 0 16px; height: 44px; }
        .text-input { flex: 1; border: none; background: none; padding: 10px 0; outline: none; font-size: 15px; color: #000; }
        .btn-icon { cursor: pointer; color: var(--m3-primary); border: none; background: none; font-family: 'Material Icons Round'; font-size: 26px; display: flex; align-items: center; }
        .call-on { color: #ff3b30 !important; }
    `;

    shadow.innerHTML = `
        <style>${style}</style>
        <div class="app-container">
            <div id="startup">
                <div class="card">
                    <h2 style="margin:0;">CodeChat</h2>
                    <div class="my-id" id="display-id">----</div>
                    <input type="text" id="p-input" class="input-m3" placeholder="Friend's Code" maxlength="4">
                    <button id="c-btn" class="btn-m3">Connect</button>
                </div>
            </div>
            <div id="app-ui" style="display:none; flex-direction:column; height:100%">
                <div class="header">
                    <span style="font-weight:500; font-size:18px">CodeChat</span>
                    <button class="btn-icon" id="call-toggle">add_ic_call</button>
                </div>
                <div class="chat-win" id="win"></div>
                <div class="footer">
                    <div class="emoji-bar" id="ebar">
                        <span class="emoji">üòÄ</span><span class="emoji">üòÇ</span><span class="emoji">üòç</span><span class="emoji">üëç</span>
                        <span class="emoji">‚ù§Ô∏è</span><span class="emoji">üî•</span><span class="emoji">üöÄ</span><span class="emoji">‚úÖ</span>
                    </div>
                    <div class="input-row">
                        <button class="btn-icon" id="f-btn">add_circle</button>
                        <input type="file" id="f-in" style="display:none">
                        <div class="field-box"><input type="text" id="m-in" class="text-input" placeholder="Type message..."></div>
                        <button class="btn-icon" style="font-size:30px" id="s-btn">send</button>
                    </div>
                </div>
            </div>
        </div>
        <audio id="r-audio" autoplay></audio>
    `;

    const myCode = Math.floor(1000 + Math.random() * 9000).toString();
    shadow.getElementById('display-id').innerText = myCode;
    const peer = new Peer(myCode);
    let conn, currentCall, isCalling = false, wakeLock = null;

    // WakeLock for Background Call
    const lockScreen = async () => {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
    };

    shadow.getElementById('p-input').oninput = (e) => {
        const btn = shadow.getElementById('c-btn');
        if(e.target.value.length === 4) btn.classList.add('active');
        else btn.classList.remove('active');
    };

    shadow.getElementById('c-btn').onclick = () => {
        conn = peer.connect(shadow.getElementById('p-input').value, { reliable: true });
        setup();
    };

    peer.on('connection', (c) => { conn = c; setup(); });

    function setup() {
        shadow.getElementById('startup').style.display = 'none';
        shadow.getElementById('app-ui').style.display = 'flex';
        conn.on('data', d => {
            if(d.type === 'text') renderMsg(decodeEmoji(d.val), 'received', d.id);
            if(d.type === 'file') renderFile(d, 'received', d.id);
            if(d.type === 'read') markRead();
            if(d.type === 'end-call') resetCallUI();
        });
    }

    // Emoji ID Encoding Logic
    const encodeEmoji = (str) => {
        return str.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDC00-\uDFFF])/g, (m) => `{EID:${m.codePointAt(0)}}`);
    };
    const decodeEmoji = (str) => {
        return str.replace(/{EID:(\d+)}/g, (m, p) => String.fromCodePoint(p));
    };

    shadow.getElementById('ebar').onclick = (e) => {
        if(e.target.classList.contains('emoji')) {
            const inp = shadow.getElementById('m-in');
            inp.value += e.target.innerText;
            inp.focus();
        }
    };

    shadow.getElementById('s-btn').onclick = () => {
        const inp = shadow.getElementById('m-in');
        if(!inp.value.trim()) return;
        const encoded = encodeEmoji(inp.value);
        conn.send({ type: 'text', val: encoded, id: myCode });
        renderMsg(inp.value, 'sent', myCode);
        inp.value = '';
    };

    function renderMsg(val, type, id) {
        const win = shadow.getElementById('win');
        const wrap = document.createElement('div');
        wrap.className = `msg-box ${type}`;
        const t = type === 'sent' ? '<span class="tick">done</span>' : '';
        wrap.innerHTML = `<div class="bubble">${val}</div><div class="meta-row"><span class="file-title">${id}</span>${t}</div>`;
        win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
        if(type === 'received') conn.send({type:'read'});
    }

    shadow.getElementById('f-btn').onclick = () => shadow.getElementById('f-in').click();
    shadow.getElementById('f-in').onchange = (e) => {
        const f = e.target.files[0];
        if(!f || f.size > 5*1024*1024) return alert("Max 5MB");
        const r = new FileReader();
        r.onload = (ev) => {
            const data = { type:'file', file: ev.target.result, name: f.name, mime: f.type, id: myCode };
            conn.send(data);
            renderFile(data, 'sent', myCode);
        };
        r.readAsArrayBuffer(f);
    };

    function renderFile(data, type, id) {
        const win = shadow.getElementById('win');
        const b = new Blob([data.file], {type: data.mime});
        const url = URL.createObjectURL(b);
        const ext = data.name.split('.').pop().toUpperCase();
        const wrap = document.createElement('div');
        wrap.className = `msg-box ${type}`;
        const t = type === 'sent' ? '<span class="tick">done</span>' : '';

        let html = `<div class="file-box">`;
        if(data.mime.startsWith('image')) html += `<img src="${url}" class="blur-img">`;
        else html += `<div style="height:160px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;">FILE</div>`;
        html += `<span class="ext-label">${ext}</span><a href="${url}" download="${data.name}" class="dl-btn">Download</a></div>`;
        
        wrap.innerHTML = `${html}<div class="meta-row"><span class="file-title">${data.name}</span> <span style="font-size:10px">${id}</span>${t}</div>`;
        win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
    }

    function markRead() {
        shadow.querySelectorAll('.tick').forEach(tk => { tk.innerText = 'done_all'; tk.style.color = '#6750a4'; });
    }

    // Call Logic
    const cBtn = shadow.getElementById('call-toggle');
    cBtn.onclick = () => {
        if(!isCalling) {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                currentCall = peer.call(conn.peer, s);
                startCallUI(currentCall);
                lockScreen();
            });
        } else {
            conn.send({type:'end-call'});
            if(currentCall) currentCall.close();
            resetCallUI();
        }
    };

    peer.on('call', c => {
        if(confirm("Answer Call?")) {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                c.answer(s);
                startCallUI(c);
                lockScreen();
            });
        }
    });

    function startCallUI(call) {
        isCalling = true;
        cBtn.innerText = 'call_end';
        cBtn.classList.add('call-on');
        call.on('stream', s => shadow.getElementById('r-audio').srcObject = s);
        call.on('close', resetCallUI);
    }

    function resetCallUI() {
        isCalling = false;
        cBtn.innerText = 'add_ic_call';
        cBtn.classList.remove('call-on');
        shadow.getElementById('r-audio').srcObject = null;
        if(wakeLock) { wakeLock.release(); wakeLock = null; }
    }
</script>

</body>
</html>
