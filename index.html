<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CodeChat - Final Fix</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body style="margin:0; padding:0; overflow:hidden; height:100vh; background:#f0f2f5;">

<div id="codechat-root"></div>

<script>
    const root = document.getElementById('codechat-root');
    const shadow = root.attachShadow({mode: 'open'});

    const style = `
        :host { --m3-surface: #fef7ff; --m3-primary: #6750a4; --m3-sent: #d0bcff; --m3-received: #eaddff; display: block; width: 100vw; height: 100vh; font-family: 'Roboto', sans-serif; overflow:hidden; }
        * { box-sizing: border-box; }
        .app-container { width: 100%; height: 100%; background: var(--m3-surface); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        #startup { position: absolute; inset: 0; background: var(--m3-surface); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: #fff; padding: 30px; border-radius: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 360px; text-align: center; }
        .my-id { font-size: 36px; font-weight: 500; color: var(--m3-primary); margin: 15px 0; letter-spacing: 2px; }
        .input-m3 { width: 100%; border: 1px solid #79747e; padding: 14px; border-radius: 8px; margin-bottom: 20px; font-size: 16px; outline: none; text-align: center; }
        .btn-m3 { background: var(--m3-primary); color: white; border: none; padding: 12px; border-radius: 100px; width: 100%; cursor: pointer; font-weight: 500; opacity: 0.5; pointer-events: none; }
        .btn-m3.active { opacity: 1; pointer-events: auto; }

        .header { height: 60px; border-bottom: 1px solid #cac4d0; display: flex; align-items: center; padding: 0 16px; justify-content: space-between; background: #fff; flex-shrink: 0; }
        .chat-win { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #faf8ff; }
        
        .msg-box { max-width: 80%; display: flex; flex-direction: column; margin-bottom: 4px; }
        .sent { align-self: flex-end; } .received { align-self: flex-start; }
        .bubble { padding: 10px 14px; border-radius: 16px; font-size: 15px; word-wrap: break-word; line-height: 1.4; position: relative; }
        .sent .bubble { background: var(--m3-sent); border-bottom-right-radius: 4px; }
        .received .bubble { background: var(--m3-received); border-bottom-left-radius: 4px; }

        .file-box { width: 220px; border-radius: 12px; overflow: hidden; position: relative; background: #e6e1e5; margin-bottom: 4px; border: 1px solid #ddd; }
        .blur-img { width: 100%; height: 160px; object-fit: cover; filter: blur(20px); display: block; }
        .dl-bar { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; font-size: 12px; font-weight: 500; }

        .meta-row { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 2px; }
        .file-title { font-size: 10px; color: #49454f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px; }
        .tick-icon { font-size: 16px; color: #79747e; font-family: 'Material Icons Round'; }

        .footer { display: flex; flex-direction: column; background: #fff; border-top: 1px solid #cac4d0; flex-shrink: 0; }
        .emoji-bar { display: flex; gap: 12px; padding: 8px 16px; overflow-x: auto; background: #f6f6f6; border-bottom: 1px solid #eee; }
        .emoji-item { cursor: pointer; font-size: 20px; user-select: none; }
        
        .input-container { padding: 10px 16px; display: flex; align-items: center; gap: 10px; }
        .input-row { flex: 1; background: #ece6f0; border-radius: 28px; display: flex; align-items: center; padding: 0 16px; }
        .text-input { flex: 1; border: none; background: none; padding: 12px 0; outline: none; font-size: 16px; color: #1d1b20; width: 100%; }
        .icon-btn { cursor: pointer; color: var(--m3-primary); border: none; background: none; font-family: 'Material Icons Round'; font-size: 26px; display: flex; align-items: center; padding: 4px; flex-shrink: 0; }
        .call-active { color: #ff3b30 !important; }
    `;

    shadow.innerHTML = `
        <style>${style}</style>
        <div class="app-container">
            <div id="startup">
                <div class="card">
                    <h2 style="margin:0; color:#1d1b20;">CodeChat</h2>
                    <div class="my-id" id="display-id">----</div>
                    <input type="text" id="p-input" class="input-m3" placeholder="Enter Friend's Code" maxlength="4" autocomplete="off">
                    <button id="c-btn" class="btn-m3">Connect</button>
                </div>
            </div>
            <div id="app-ui" style="display:none; flex-direction:column; height:100%">
                <div class="header">
                    <span style="font-size:20px; font-weight:500;">CodeChat</span>
                    <button class="icon-btn" id="call-toggle">add_ic_call</button>
                </div>
                <div class="chat-win" id="win"></div>
                <div class="footer">
                    <div class="emoji-bar" id="emoji-bar">
                        <span class="emoji-item">üòÄ</span><span class="emoji-item">üòÉ</span><span class="emoji-item">üòÑ</span><span class="emoji-item">üòÅ</span>
                        <span class="emoji-item">üòÖ</span><span class="emoji-item">üòÇ</span><span class="emoji-item">ü§£</span><span class="emoji-item">üòä</span>
                        <span class="emoji-item">üòá</span><span class="emoji-item">ü•∞</span><span class="emoji-item">üòç</span><span class="emoji-item">ü§©</span>
                        <span class="emoji-item">üòò</span><span class="emoji-item">üòó</span><span class="emoji-item">üòö</span><span class="emoji-item">üòã</span>
                        <span class="emoji-item">üòõ</span><span class="emoji-item">üòú</span><span class="emoji-item">ü§™</span><span class="emoji-item">ü§®</span>
                    </div>
                    <div class="input-container">
                        <button class="icon-btn" id="attach-btn">add_circle</button>
                        <input type="file" id="f-in" style="display:none">
                        <div class="input-row"><input type="text" id="m-in" class="text-input" placeholder="Message..."></div>
                        <button class="icon-btn" style="font-size:32px" id="s-btn">send</button>
                    </div>
                </div>
            </div>
        </div>
        <audio id="r-audio" autoplay></audio>
    `;

    const myCode = Math.floor(1000 + Math.random() * 9000).toString();
    shadow.getElementById('display-id').innerText = myCode;
    const peer = new Peer(myCode);
    let conn, currentCall, isCalling = false;

    shadow.getElementById('p-input').oninput = (e) => {
        const btn = shadow.getElementById('c-btn');
        if(e.target.value.length === 4) btn.classList.add('active');
        else btn.classList.remove('active');
    };

    shadow.getElementById('c-btn').onclick = () => {
        conn = peer.connect(shadow.getElementById('p-input').value, { reliable: true });
        setupConnection();
    };

    peer.on('connection', (incoming) => {
        conn = incoming;
        setupConnection();
    });

    function setupConnection() {
        shadow.getElementById('startup').style.display = 'none';
        shadow.getElementById('app-ui').style.display = 'flex';
        conn.on('data', d => {
            if(d.type === 'text') renderMsg(d.val, 'received', d.id);
            if(d.type === 'file') renderFile(d, 'received', d.id);
            if(d.type === 'read') markAsRead();
            if(d.type === 'call-sync') updateCallUI(d.active); // Sync call state
        });
    }

    // Emoji Bar Integration
    shadow.getElementById('emoji-bar').onclick = (e) => {
        if(e.target.classList.contains('emoji-item')) {
            const inp = shadow.getElementById('m-in');
            inp.value += e.target.innerText;
            inp.focus();
        }
    };

    shadow.getElementById('m-in').onkeydown = (e) => { if(e.key === 'Enter') shadow.getElementById('s-btn').click(); };

    shadow.getElementById('s-btn').onclick = () => {
        const inp = shadow.getElementById('m-in');
        if(!inp.value.trim()) return;
        conn.send({ type: 'text', val: inp.value, id: myCode });
        renderMsg(inp.value, 'sent', myCode);
        inp.value = '';
    };

    function renderMsg(val, type, id) {
        const win = shadow.getElementById('win');
        const wrap = document.createElement('div');
        wrap.className = `msg-box ${type}`;
        const tick = type === 'sent' ? '<span class="tick-icon">done</span>' : '';
        wrap.innerHTML = `<div class="bubble">${val}</div><div class="meta-row"><span class="file-title">${id}</span>${tick}</div>`;
        win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
        if(type === 'received') conn.send({type:'read'});
    }

    shadow.getElementById('attach-btn').onclick = () => shadow.getElementById('f-in').click();
    shadow.getElementById('f-in').onchange = (e) => {
        const f = e.target.files[0];
        if(!f || f.size > 5*1024*1024) return alert("Max size 5MB");
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = { type: 'file', file: ev.target.result, name: f.name, mime: f.type, id: myCode };
            conn.send(data);
            renderFile(data, 'sent', myCode);
        };
        reader.readAsArrayBuffer(f);
    };

    function renderFile(data, type, id) {
        const win = shadow.getElementById('win');
        const blob = new Blob([data.file], {type: data.mime});
        const url = URL.createObjectURL(blob);
        const ext = data.name.split('.').pop().toUpperCase();
        const wrap = document.createElement('div');
        wrap.className = `msg-box ${type}`;
        const tick = type === 'sent' ? '<span class="tick-icon">done</span>' : '';

        let content = `<div class="file-box">`;
        if(data.mime.startsWith('image')) content += `<img src="${url}" class="blur-img">`;
        else content += `<div style="height:160px; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:bold; color:var(--m3-primary)">${ext}</div>`;
        content += `<span class="ext-tag">${ext}</span><a href="${url}" download="${data.name}" class="dl-bar"><span class="material-icons-round">arrow_downward</span> Download File</a></div>`;
        
        wrap.innerHTML = `${content}<div class="meta-row"><span class="file-title">${data.name}</span> <span style="font-size:10px; margin-left:5px;">${id}</span>${tick}</div>`;
        win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
    }

    function markAsRead() {
        shadow.querySelectorAll('.tick-icon').forEach(tk => { tk.innerText = 'done_all'; tk.style.color = '#6750a4'; });
    }

    // Call Sync Logic
    const callBtn = shadow.getElementById('call-toggle');
    callBtn.onclick = () => {
        if(!isCalling) {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                currentCall = peer.call(conn.peer, s);
                updateCallUI(true);
                conn.send({type: 'call-sync', active: true});
                currentCall.on('stream', rs => shadow.getElementById('r-audio').srcObject = rs);
                currentCall.on('close', () => { if(isCalling) updateCallUI(false); });
            });
        } else {
            if(currentCall) currentCall.close();
            conn.send({type: 'call-sync', active: false});
            updateCallUI(false);
        }
    };

    peer.on('call', call => {
        if(confirm("Incoming call. Answer?")) {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                call.answer(s);
                currentCall = call;
                updateCallUI(true);
                call.on('stream', rs => shadow.getElementById('r-audio').srcObject = rs);
                call.on('close', () => { if(isCalling) updateCallUI(false); });
            });
        }
    });

    function updateCallUI(active) {
        isCalling = active;
        if(active) {
            callBtn.innerText = 'call_end';
            callBtn.classList.add('call-active');
        } else {
            callBtn.innerText = 'add_ic_call';
            callBtn.classList.remove('call-active');
            shadow.getElementById('r-audio').srcObject = null;
        }
    }
</script>

</body>
</html>
